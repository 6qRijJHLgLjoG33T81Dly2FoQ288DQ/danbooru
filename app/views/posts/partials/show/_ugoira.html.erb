<%= content_tag(:canvas, nil,
                :id => "image",
                :width => post.image_width,
                :height => post.image_height,
                "data-original-width" => post.image_width,
                "data-original-height" => post.image_height,
                "data-large-width" => post.image_width,
                "data-large-height" => post.image_height,
                "data-tags" => post.tag_string,
                "data-uploader" => post.uploader_name,
                "data-rating" => post.rating,
                "data-flags" => post.status_flags,
                "data-parent-id" => post.parent_id,
                "data-has-children" => post.has_children?,
                "data-has-active-children" => post.has_active_children?,
                "data-score" => post.score,
                "data-fav-count" => post.fav_count) %>

<div id="ugoira-controls">
  <div id="progressbar" style="width: <%= post.image_width %>px;"></div>
  <%= button_tag "Play", :id => "ugoira-play", :style => "display: none;" %>
  <%= button_tag "Pause", :id => "ugoira-pause" %>  
  <%= button_tag "Rewind", :id => "ugoira-rewind" %>
  <%= link_to "Save as video (right click and save)", post.large_file_url %>
</div>

<% content_for(:html_header) do %>
  <%= javascript_include_tag "ugoira_player" %>
  <script type="text/javascript">
    Danbooru.Ugoira = {};

    Danbooru.Ugoira.create_player = function() {
      var meta_data = {
        mime_type: <%= raw @post.pixiv_ugoira_frame_data.content_type.to_json %>,
        frames: <%= raw @post.pixiv_ugoira_frame_data.data.to_json %>
      };
      var options = {
        canvas: document.getElementById("image"),
        source: "<%= @post.file_url %>",
        metadata: meta_data,
        chunkSize: 300000,
        loop: true,
        autoStart: true,
        debug: false,
      }
      this.player = new ZipImagePlayer(options);
    }

    Danbooru.Ugoira.player = null;

    $(function() {
      Danbooru.Ugoira.create_player();
      $(Danbooru.Ugoira.player).on("loadProgress", function(ev, progress) {
        $("#progressbar").progressbar({value: progress * 100});
      });
      $(Danbooru.Ugoira.player).on("loadingStateChanged", function(ev, state) {
        if (state === 2) {
          $("#progressbar").remove();
        }
      });

      $("#ugoira-play").click(function(e) {
        Danbooru.Ugoira.player.play();
        $(this).hide();
        $("#ugoira-pause").show();
        e.preventDefault();
      })
      $("#ugoira-pause").click(function(e) {
        Danbooru.Ugoira.player.pause();
        $(this).hide();
        $("#ugoira-play").show();
        e.preventDefault();
      });
      $("#ugoira-rewind").click(function(e) {
        Danbooru.Ugoira.player.rewind();
        e.preventDefault();
      });
    });
  </script>
<% end %>
